<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>HybridImage</title>
    <script src="./opencv.js"></script>
    <style>
        body{
            font-family:Arial,sans-serif;
            margin:0;
            padding:20px;
            padding-top:0px
        }

        .nav{
            background-color:#4CAF50;
            padding:10px;
            display:flex;
            justify-content:space-around
        }

        button{
            padding:10px 20px;
            font-size:16px;
            cursor:pointer;
            background-color:#45a049;
            color:white;
            border:none;
            border-radius:5px
        }

        button:hover{
            background-color:#3e8e41
        
        }

        .image-container{
            display:flex;
            justify-content:space-around;
            flex-grow:1;
            padding:20px
        }

        .image-box{
            border:2px solid #ddd;
            padding:10px;
            text-align:center
        }

        #resultImage{
            max-width:100%;
            max-height:400px
        }

        .slider-container{
            margin-top:20px;
        }

        .slider{
            width:98%;
            left:1%;
            margin:10px 0
        }
    </style>
</head>

<body>
    <div class="nav">
        <button id="LoadImage1">加载图片1</button>
        <button id="LoadImage2">加载图片2</button>
        <button id="ProcessImages">处理图像</button>
        <button id="saveImage">保存结果</button>
    </div>

    <div class="image-container">
        <div class="image-box">
            <img id="image1" alt="原始图片1">
        </div>
        <div class="image-box">
            <img id="image2" alt="原始图片2">
        </div>
    </div>

    <div class="image-container">
        <div class="image-box">
            <canvas id="image1HighFreq" alt="图片1高频"></canvas>
        </div>
        <div class="image-box">
            <canvas id="image2LowFreq" alt="图片2低频"></canvas>
        </div>
    </div>

    <div class="slider-container">
        <div>
            <label for="alphaSlider">Alpha: <span id="alphaSliderValue">0</span></label>
            <input type="range" id="alphaSlider" class="slider" min="0" max="100" value="0">
        </div>
        <div>
            <label for="kernel1Slider">Kernel 1 Size: <span id="kernel1SliderValue">1</span></label>
            <input type="range" id="kernel1Slider" class="slider" min="1" max="100" value="1" step="2">
        </div>
        <div>
            <label for="kernel2Slider">Kernel 2 Size: <span id="kernel2SliderValue">1</span></label>
            <input type="range" id="kernel2Slider" class="slider" min="1" max="100" value="1" step="2">
        </div>
        <div>
            <label for="sigmaXSlider">Sigma X: <span id="sigmaXSliderValue">0</span></label>
            <input type="range" id="sigmaXSlider" class="slider" min="0" max="15" value="0" step="0.05">
        </div>
        <div>
            <label for="sigmaYSlider">Sigma Y: <span id="sigmaYSliderValue">0</span></label>
            <input type="range" id="sigmaYSlider" class="slider" min="0" max="15" value="0" step="0.1">
        </div>
    </div>

    <div class="result">
        <div class="image-box">
            <canvas id="resultCanvas"></canvas>
        </div>
    </div>

    <script>
        let img1,img2,result;
        const kernelSizeMax=100;
        const alphaSliderMax=100;
        const sigmaXSliderMax=15;
        const sigmaYSliderMax=15;

        function GetReady(){
            console.log('OpenCV.js is ready');
    
            document.getElementById('LoadImage1').addEventListener('click',()=>LoadImage('image1'));
            document.getElementById('LoadImage2').addEventListener('click',()=>LoadImage('image2'));
            document.getElementById('ProcessImages').addEventListener('click',ProcessImages);
            document.getElementById('saveImage').addEventListener('click',SaveResult);
           
            const sliders=['alphaSlider','kernel1Slider','kernel2Slider','sigmaXSlider','sigmaYSlider'];
            sliders.forEach(sliderId=>{
                const slider=document.getElementById(sliderId);
                if(slider){
                    slider.addEventListener('input',UpdateSliderValue);
                }else{
                    console.error(`滑动条${sliderId}未找到`);
                }
            });
        }
        function UpdateSliderValue(e){
            // 获取滑动条的值
            const valueElement=document.getElementById(`${e.target.id}Value`);
            if(valueElement){
                // 更新滑动条的值
                valueElement.textContent=e.target.value;
                ProcessImages();
            }else{
                console.error(`未找到与滑动条 ${e.target.id} 对应的值显示元素，但继续处理图像`);
                ProcessImages();
            }
        }
        function LoadImage(imageId){
            const input=document.createElement('input');
            input.type='file';
            input.accept='image/*';
            input.onchange=(e)=>{
                const file=e.target.files[0];
                const reader=new FileReader();
                reader.onload=(event)=>{
                    document.getElementById(imageId).src=event.target.result;
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }
        function ProcessImages(){
            // 检查opencv.js
            if(typeof cv==='undefined'){
                console.error('OpenCV.js is not loaded yet');
                return;
            }
            // 读取图片
            img1=cv.imread('image1');
            img2=cv.imread('image2');

            if(img1.empty()||img2.empty()){
                console.error('图像读取失败');
                return;
            }
            // 调整图片尺寸
            cv.resize(img2,img2,new cv.Size(img1.cols,img1.rows));

            let imgCatGaus=new cv.Mat();
            let imgDogGaus=new cv.Mat();
            let highFreq=new cv.Mat();
            let lowFreq=new cv.Mat();
            result=new cv.Mat();

            // 获取滑动条的值
            let alpha=parseInt(document.getElementById('alphaSlider').value)/alphaSliderMax;
            let kernel1=parseInt(document.getElementById('kernel1Slider').value);
            let kernel2=parseInt(document.getElementById('kernel2Slider').value);
            let sigmaX=parseInt(document.getElementById('sigmaXSlider').value);
            let sigmaY=parseInt(document.getElementById('sigmaYSlider').value);

            // 高斯滤波
            cv.GaussianBlur(img1,imgCatGaus,new cv.Size(kernel1,kernel1),sigmaX,sigmaY);
            cv.GaussianBlur(img2,imgDogGaus,new cv.Size(kernel2,kernel2),sigmaX,sigmaY);

            // 获取高频
            cv.subtract(img1,imgCatGaus,highFreq);

            // 增强对比度
            let highFreqEnhanced=new cv.Mat();
            cv.convertScaleAbs(highFreq,highFreqEnhanced,2,128);

            //获取低频
            lowFreq=imgDogGaus;

            // 混合
            cv.addWeighted(highFreqEnhanced,alpha,lowFreq,1.0-alpha,0.0,result);

            // 打印图片
            cv.imshow('image1HighFreq',highFreqEnhanced);
            cv.imshow('image2LowFreq',lowFreq);
            cv.imshow('resultCanvas',result);

            // 释放内存
            img1.delete();
            img2.delete(); 
            imgCatGaus.delete(); 
            imgDogGaus.delete(); 
            highFreq.delete();
            highFreqEnhanced.delete();
            lowFreq.delete();
        }
        function SaveResult(){
            const canvas=document.getElementById('resultCanvas');
            if(canvas){
                let link=document.createElement('a');
                link.download='result.png';
                link.href=canvas.toDataURL();
                link.click();
            }else{
                console.error('没有可保存的结果');
            }
        }
        (()=>{
            document.addEventListener('DOMContentLoaded',()=>{
                if(typeof cv!=='undefined'){
                    GetReady();
                }else{
                    console.error('OpenCV.js未能正确加载');
                }
            });
        })();
    </script>
</body>
</html>
