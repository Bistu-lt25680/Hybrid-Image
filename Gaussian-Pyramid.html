<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Gaussian Pyramid</title>
    <script src="./opencv.js"></script>
    <style>
        body{
            font-family:Arial,sans-serif;
            margin:0;
            padding:20px;
            padding-top:0px
        }

        .nav{
            background-color:#4CAF50;
            padding:10px;
            display:flex;
            justify-content:space-around
        }

        button{
            padding:10px 20px;
            font-size:16px;
            cursor:pointer;
            background-color:#45a049;
            color:white;
            border:none;
            border-radius:5px
        }

        button:hover{
            background-color:#3e8e41
        
        }

        .image-container{
            display:flex;
            justify-content:space-around;
            flex-grow:1;
            padding:20px
        }

        .image-box{
            border:2px solid #ddd;
            padding:10px;
            text-align:center
        }

        #resultImage{
            max-width:100%;
            max-height:400px
        }

        .slider-container{
            margin-top:20px;
        }

        .slider{
            width:98%;
            left:1%;
            margin:10px 0
        }
    </style>
</head>

<body>
    <div class="nav">
        <button id="LoadImage1">加载图片1</button>
        <button id="LoadImage2">加载图片2</button>
        <button id="ProcessImages">处理图像</button>
        <button id="saveImage">保存结果</button>
        <button id="jump">高斯滤波</button>
    </div>

    <div class="image-container">
        <div class="image-box">
            <img id="image1" alt="原始图片1">
        </div>
        <div class="image-box">
            <img id="image2" alt="原始图片2">
        </div>
    </div>

    <div class="image-container">
        <div class="image-box">
            <canvas id="image1HighFreq" alt="图片1高频"></canvas>
        </div>
        <div class="image-box">
            <canvas id="image2LowFreq" alt="图片2低频"></canvas>
        </div>
    </div>

    <div class="slider-container">
        <div>
            <label for="alphaSlider">Alpha: <span id="alphaSliderValue">0</span></label>
            <input type="range" id="alphaSlider" class="slider" min="0" max="100" value="0">
        </div>
        <div>
            <label for="kernel1Slider">Kernel 1 Size: <span id="kernel1SliderValue">1</span></label>
            <input type="range" id="kernel1Slider" class="slider" min="1" max="100" value="1" step="2">
        </div>
        <div>
            <label for="kernel2Slider">Kernel 2 Size: <span id="kernel2SliderValue">1</span></label>
            <input type="range" id="kernel2Slider" class="slider" min="1" max="100" value="1" step="2">
        </div>
        <div>
            <label for="sigmaXSlider">Sigma X: <span id="sigmaXSliderValue">0</span></label>
            <input type="range" id="sigmaXSlider" class="slider" min="0" max="15" value="0" step="0.05">
        </div>
        <div>
            <label for="sigmaYSlider">Sigma Y: <span id="sigmaYSliderValue">0</span></label>
            <input type="range" id="sigmaYSlider" class="slider" min="0" max="15" value="0" step="0.1">
        </div>
    </div>

    <div class="result">
        <div class="image-box">
            <canvas id="resultCanvas"></canvas>
        </div>
    </div>

    <script>
        let img1,img2,result;
        const kernelSizeMax=100;
        const alphaSliderMax=100;
        const sigmaXSliderMax=15;
        const sigmaYSliderMax=15;

        function GetReady(){
            console.log('OpenCV.js is ready');
    
            document.getElementById('LoadImage1').addEventListener('click',()=>LoadImage('image1'));
            document.getElementById('LoadImage2').addEventListener('click',()=>LoadImage('image2'));
            document.getElementById('ProcessImages').addEventListener('click',ProcessImages);
            document.getElementById('saveImage').addEventListener('click',SaveResult);
            document.getElementById('jump').addEventListener('click',()=>{
                let link=document.createElement('a');
                link.href='index.html';
                link.click();
            });
           
            const sliders=['alphaSlider','kernel1Slider','kernel2Slider','sigmaXSlider','sigmaYSlider'];
            sliders.forEach(sliderId=>{
                const slider=document.getElementById(sliderId);
                if(slider){
                    slider.addEventListener('input',UpdateSliderValue);
                }else{
                    console.error(`滑动条${sliderId}未找到`);
                }
            });
        }
        function UpdateSliderValue(e){
            // 获取滑动条的值
            const valueElement=document.getElementById(`${e.target.id}Value`);
            if(valueElement){
                // 更新滑动条的值
                valueElement.textContent=e.target.value;
                ProcessImages();
            }else{
                console.error(`未找到与滑动条 ${e.target.id} 对应的值显示元素，但继续处理图像`);
                ProcessImages();
            }
        }
        function LoadImage(imageId){
            const input=document.createElement('input');
            input.type='file';
            input.accept='image/*';
            input.onchange=(e)=>{
                const file=e.target.files[0];
                const reader=new FileReader();
                reader.onload=(event)=>{
                    document.getElementById(imageId).src=event.target.result;
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }
        function ProcessImages() {
            console.log('开始处理图像');
            // 检查opencv.js
            if (typeof cv === 'undefined') {
                console.error('OpenCV.js is not loaded yet');
                return;
            }
            // 读取图片
            let img1 = cv.imread('image1');
            let img2 = cv.imread('image2');

            if (img1.empty() || img2.empty()) {
                console.error('图像读取失败');
                return;
            }
            let alpha = parseInt(document.getElementById('alphaSlider').value) / alphaSliderMax;
            let kernel1 = parseInt(document.getElementById('kernel1Slider').value);
            let kernel2 = parseInt(document.getElementById('kernel2Slider').value);
            let sigmaX = parseFloat(document.getElementById('sigmaXSlider').value);
            let sigmaY = parseFloat(document.getElementById('sigmaYSlider').value);
            console.log(`参数: alpha=${alpha}, kernel1=${kernel1}, kernel2=${kernel2}, sigmaX=${sigmaX}, sigmaY=${sigmaY}`);
            
            // 调整图片尺寸
            cv.resize(img2, img2, new cv.Size(img1.cols, img1.rows));

            let img1Original = img1.clone();
            let img2Original = img2.clone();

            let temp1 = new cv.Mat();
            let temp2 = new cv.Mat();

            // 三次高斯模糊和缩小操作
            for (let i = 0; i < 3; i++) {
                cv.GaussianBlur(img1, img1, new cv.Size(kernel1, kernel1), sigmaX, sigmaY);
                cv.GaussianBlur(img2, img2, new cv.Size(kernel2, kernel2), sigmaX, sigmaY);

                // 缩小图像，保持宽高比
                let newSize1 = new cv.Size(Math.max(1, Math.floor(img1.cols / 2)), Math.max(1, Math.floor(img1.rows / 2)));
                let newSize2 = new cv.Size(Math.max(1, Math.floor(img2.cols / 2)), Math.max(1, Math.floor(img2.rows / 2)));
                cv.resize(img1, temp1, newSize1, 0, 0, cv.INTER_AREA);
                cv.resize(img2, temp2, newSize2, 0, 0, cv.INTER_AREA);

                // 将缩小后的图像赋值回原变量
                temp1.copyTo(img1);
                temp2.copyTo(img2);
            }


            // 放大三次
            for (let i = 0; i < 3; i++) {
                let newSize1 = new cv.Size(img1.cols * 2, img1.rows * 2);
                let newSize2 = new cv.Size(img2.cols * 2, img2.rows * 2);
                cv.resize(img1, img1, newSize1, 0, 0, cv.INTER_LINEAR);
                cv.resize(img2, img2, newSize2, 0, 0, cv.INTER_LINEAR);
            }


            // 确保所有图像尺寸相同
            cv.resize(img1, img1, new cv.Size(img1Original.cols, img1Original.rows));
            cv.resize(img2, img2, new cv.Size(img1Original.cols, img1Original.rows));

            // 计算高频部分
            let imgHighFreq = new cv.Mat();
            cv.subtract(img1Original, img1, imgHighFreq);

            // 归一化
            let normalized = new cv.Mat();
            cv.normalize(imgHighFreq, normalized, 0, 255, cv.NORM_MINMAX, cv.CV_8U);

            // 增强对比度
            let highFreqEnhanced=new cv.Mat();
            cv.convertScaleAbs(normalized,highFreqEnhanced,1,128);

            // 显示高频和低频部分
            cv.imshow('image1HighFreq', highFreqEnhanced);
            cv.imshow('image2LowFreq', img2);

            let result = new cv.Mat();
            cv.addWeighted(highFreqEnhanced, alpha, img2, 1.0 - alpha, 0.0, result);

            // 显示最终结果
            cv.imshow('resultCanvas', result);

            // 释放内存
            img1.delete();
            img2.delete();
            img1Original.delete();
            img2Original.delete();
            temp1.delete();
            temp2.delete();
            normalized.delete();
            highFreqEnhanced.delete();
            imgHighFreq.delete();
            result.delete();

        }
        function SaveResult(){
            const canvas=document.getElementById('resultCanvas');
            if(canvas){
                let link=document.createElement('a');
                link.download='result.png';
                link.href=canvas.toDataURL();
                link.click();
            }else{
                console.error('没有可保存的结果');
            }
        }
        (()=>{
            document.addEventListener('DOMContentLoaded',()=>{
                if(typeof cv!=='undefined'){
                    GetReady();
                }else{
                    console.error('OpenCV.js未能正确加载');
                }
            });
        })();
    </script>
</body>
</html>
